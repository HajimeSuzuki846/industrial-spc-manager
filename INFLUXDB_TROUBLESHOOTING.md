# InfluxDB接続トラブルシューティング

## 問題の概要
InfluxDB接続テスト時にバックエンドサーバーがクラッシュしたり、WebSocket接続が切断される問題が発生しています。

## 修正内容

### 1. グローバルエラーハンドラーの追加
- `uncaughtException`と`unhandledRejection`のハンドラーを追加
- サーバーが予期しないエラーでクラッシュすることを防止

### 2. InfluxDB接続テストの改善
- タイムアウト機能を追加（10秒）
- より詳細なエラーメッセージを提供
- 接続エラーの種類に応じた適切なHTTPステータスコードを返す

### 3. InfluxDBマネージャーの改善
- エラー処理を改善し、例外を投げる代わりにエラーオブジェクトを返す
- 組織やバケットが見つからない場合の適切なエラーハンドリング
- 接続テストメソッドの追加

### 4. フロントエンドエラーハンドリングの改善
- より詳細なエラーメッセージを表示
- ネットワークエラーの適切な処理
- コンソールログの追加によるデバッグ支援

## トラブルシューティング手順

### 1. バックエンドサーバーの状態確認
```bash
# バックエンドディレクトリに移動
cd backend

# ヘルスチェック
curl http://localhost:3001/api/health
```

### 2. InfluxDBサーバーの状態確認
```bash
# InfluxDBが起動しているか確認
curl http://localhost:8086/health

# または
influx ping
```

### 3. InfluxDB接続の手動テスト
```bash
# バックエンドディレクトリで実行
node test-influxdb.js
```

### 4. 設定の確認
- InfluxDBのURLが正しいか確認（デフォルト: http://localhost:8086）
- APIトークンが正しいか確認
- 組織名が存在するか確認
- バケット名が正しいか確認

## よくあるエラーと対処法

### 1. "InfluxDBサーバーに接続できません"
- InfluxDBサーバーが起動しているか確認
- ポート8086が正しく開いているか確認
- ファイアウォールの設定を確認

### 2. "認証に失敗しました"
- APIトークンが正しいか確認
- トークンに適切な権限があるか確認

### 3. "組織が見つかりません"
- 組織名のスペルを確認
- 組織が実際に存在するか確認
- 利用可能な組織の一覧を確認

### 4. "バケットが見つかりません"
- バケット名のスペルを確認
- バケットが自動作成されるか確認
- 手動でバケットを作成

## ログの確認

### バックエンドログ
```bash
# バックエンドサーバーのログを確認
cd backend
npm start
```

### InfluxDBログ
```bash
# InfluxDBのログを確認（Linuxの場合）
sudo journalctl -u influxdb -f

# Windowsの場合
# イベントビューアーでInfluxDBのログを確認
```

## 追加のデバッグ情報

### 1. ネットワーク接続の確認
```bash
# InfluxDBポートへの接続確認
telnet localhost 8086

# または
nc -zv localhost 8086
```

### 2. InfluxDB CLIでの接続確認
```bash
# InfluxDB CLIで接続テスト
influx ping
influx org list
influx bucket list
```

## 修正後の動作確認

1. バックエンドサーバーを再起動
2. フロントエンドでInfluxDB設定画面を開く
3. 接続テストを実行
4. エラーメッセージが詳細に表示されることを確認
5. サーバーがクラッシュしないことを確認
6. WebSocket接続が維持されることを確認

## 今後の改善点

- InfluxDB接続の自動再試行機能
- 接続状態の監視機能
- より詳細なメトリクスの収集
- 接続プールの実装
