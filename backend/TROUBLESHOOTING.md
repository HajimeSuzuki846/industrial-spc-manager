# データベース接続とMQTT接続のトラブルシューティング

## データベース接続の問題

### 1. PostgreSQLサーバーが起動していない
**症状**: `ECONNREFUSED` エラー
**解決方法**:
```bash
# PostgreSQLサービスを起動
# Windowsの場合
net start postgresql-x64-15

# Linuxの場合
sudo systemctl start postgresql
```

### 2. 認証エラー
**症状**: `28P01` エラー
**解決方法**:
- ユーザー名とパスワードを確認
- PostgreSQLの認証設定を確認

### 3. データベースが存在しない
**症状**: `3D000` エラー
**解決方法**:
```sql
CREATE DATABASE asset_manager;
```

### 4. 接続設定の確認
以下の設定を確認してください：
- ホスト: `localhost` または PostgreSQLサーバーのIP
- ポート: `5432` (デフォルト)
- データベース名: `asset_manager`
- ユーザー名: `postgres` または設定したユーザー
- パスワード: 設定したパスワード

## MQTT接続の問題

### 1. ブローカーに接続できない
**症状**: 接続タイムアウト
**解決方法**:
- ブローカーのURLとポートを確認
- ファイアウォール設定を確認
- ネットワーク接続を確認

### 2. 証明書認証エラー
**症状**: SSL/TLS接続エラー
**解決方法**:
- 証明書ファイルのパスを確認
- 証明書ファイルの内容を確認
- CA証明書の設定を確認

### 3. クライアントID重複
**症状**: 接続が拒否される
**解決方法**:
- 一意のクライアントIDを使用
- 既存の接続を切断してから再接続

## 環境変数の設定

`.env`ファイルを作成して以下の設定を追加してください：

```env
PORT=3001
NODE_ENV=development
DB_HOST=localhost
DB_PORT=5432
DB_NAME=asset_manager
DB_USER=postgres
DB_PASSWORD=your_password
```

## ログの確認

サーバーのログを確認してエラーの詳細を把握してください：

```bash
# サーバーを起動
cd backend
node server.js
```

## よくあるエラーと解決方法

### データベース関連
1. **"データベースに接続されていません"**
   - PostgreSQLサーバーが起動しているか確認
   - 接続設定が正しいか確認

2. **"認証に失敗しました"**
   - ユーザー名とパスワードを確認
   - PostgreSQLの認証設定を確認

3. **"データベースが存在しません"**
   - データベースを作成
   - データベース名のスペルを確認

### MQTT関連
1. **"ブローカー、ポート、クライアントIDは必須です"**
   - 設定画面で必須項目を入力

2. **"証明書ファイルの読み込みに失敗しました"**
   - 証明書ファイルのパスを確認
   - ファイルが存在するか確認
   - ファイルの権限を確認

3. **"証明書設定エラー"**
   - 証明書ファイルの形式を確認
   - ファイルの内容を確認

## テスト方法

### データベース接続テスト
1. フロントエンドの設定画面でPostgreSQL設定を入力
2. "接続テスト"ボタンをクリック
3. 成功メッセージが表示されることを確認

### MQTT接続テスト
1. フロントエンドの設定画面でMQTT設定を入力
2. "接続"ボタンをクリック
3. 接続状態が"接続済み"になることを確認

## サポート

問題が解決しない場合は、以下の情報を確認してください：
- エラーメッセージの詳細
- サーバーログの出力
- 設定値（パスワードは除く）
- 使用しているPostgreSQLとMQTTブローカーのバージョン
